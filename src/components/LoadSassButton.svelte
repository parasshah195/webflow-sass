<script lang="ts">
  import { onDestroy, onMount } from 'svelte';

  import { ERROR_TEXTS, showWebflowError } from '../js/webflowNotify';
  import { removeFilenameExtension } from '../js/filename';
  import { getNewEditorState } from './Editor.svelte';
  import type { EditorView } from 'codemirror';
  import type { EditorFileTypes, LoadedSassEl } from './EditorForm.svelte';

  let clickable = false;
  export let filename: string;
  export let CODEMIRROR_INSTANCE: EditorView;
  export let EDITOR_FILE_TYPE: EditorFileTypes;
  export let LOADED_SASS_EL: LoadedSassEl;

  let webflowSelectedElUnsub: () => undefined;

  onMount(() => {
    webflowSelectedElUnsub = webflow.subscribe(
      'selectedelement',
      (selectedEl) => {
        console.log('element change trigger', 'sass app');
        if (
          !selectedEl ||
          'DOM' !== selectedEl.type ||
          'template' !== selectedEl.getTag()
        ) {
          clickable = false;
          return;
        }

        clickable = true;
      }
    );
  });

  onDestroy(() => {
    webflowSelectedElUnsub();
  });

  async function loadSass() {
    EDITOR_FILE_TYPE = 'load';

    const sassEl = (await webflow.getSelectedElement()) as DOMElement;
    if (!sassEl || !sassEl.children) {
      await showWebflowError(ERROR_TEXTS.invalidSassElLoad);
      return;
    }

    LOADED_SASS_EL = sassEl;

    let currentFileName = '';

    if (sassEl.styles) {
      const currentElStyles = await sassEl.getStyles();
      const currentFileNameWithExtn = currentElStyles[0].getName();
      currentFileName = removeFilenameExtension(currentFileNameWithExtn);

      filename = currentFileName;
    }

    const currentSassStringEl = sassEl.getChildren()[0];

    if ('String' !== currentSassStringEl.type) {
      await showWebflowError(ERROR_TEXTS.sassLoadNoCode);
      return;
    }

    const currentSassContent = currentSassStringEl.getText();
    CODEMIRROR_INSTANCE.setState(getNewEditorState(currentSassContent));
  }
</script>

<button
  class="button-default"
  disabled={!clickable}
  on:click|preventDefault={loadSass}>Load selected element Sass</button
>
